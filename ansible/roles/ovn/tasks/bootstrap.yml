---
- name: Create br-int bridge on OpenvSwitch
  become: true
  kolla_toolbox:
    user: root
    module_name: openvswitch_bridge
    module_args:
      bridge: br-int
      state: present
      fail_mode: secure

- name: Configure OVN in OVSDB
  vars:
    ovn_mappings: "{% for bridge in neutron_bridge_name.split(',') %}physnet{{ loop.index0 + 1 }}:{{ bridge }}{% if not loop.last %},{% endif %}{% endfor %}"
    ovn_macs: "{% for bridge in neutron_bridge_name.split(',') %}physnet{{ loop.index0 + 1 }}:{{ ovn_base_mac | random_mac(seed=inventory_hostname) }}{% if not loop.last %},{% endif %}{% endfor %}"
    ovn_cms_opts: "{{ 'enable-chassis-as-gw' if inventory_hostname in groups['ovn-controller-network'] else '' }}"
  become: true
  kolla_toolbox:
    user: root
    module_name: openvswitch_db
    module_args:
      table: Open_vSwitch
      record: .
      col: external_ids
      key: "{{ item.name }}"
      value: "{{ item.value }}"
  loop:
    - { name: ovn-encap-ip, value: "{{ tunnel_interface_address }}" }
    - { name: ovn-encap-type, value: geneve }
    - { name: ovn-remote, value: "{{ ovn_sb_connection }}" }
    - { name: ovn-remote-probe-interval, value: "{{ ovn_remote_probe_interval }}" }
    - { name: ovn-bridge-mappings, value: "{{ ovn_mappings }}", when: "{{ inventory_hostname in groups['ovn-controller-network'] or computes_need_external_bridge | bool }}" }
    - { name: ovn-chassis-mac-mappings, value: "{{ ovn_macs }}", when: "{{ inventory_hostname in groups['ovn-controller-network'] or computes_need_external_bridge | bool }}" }
    - { name: ovn-cms-options, value: "{{ ovn_cms_opts }}" }
  when: item.when | default(True)
